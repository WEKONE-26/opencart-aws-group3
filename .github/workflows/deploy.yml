name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Multi-AZ EC2 Instances
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Deploy to EC2-A via SSM
        run: |
          echo "=== Deploying to EC2-A via SSM Session Manager ==="
          
          aws ssm send-command \
            --instance-ids i-082cbe43b6ba19a6e \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "echo \"=== Deploying to EC2-A ===\"",
              "sudo cp -r /var/www/html /var/www/html.backup.$(date +%Y%m%d_%H%M%S)",
              "cd /tmp && rm -rf opencart-deployment",
              "git clone https://github.com/WEKONE-26/opencart-aws-group3.git opencart-deployment",
              "sudo rsync -av --exclude=config.php --exclude=admin/config.php --exclude=system/storage/ --exclude=image/ /tmp/opencart-deployment/ /var/www/html/",
              "sudo chown -R apache:apache /var/www/html",
              "sudo chmod -R 755 /var/www/html",
              "sudo rm -rf /var/www/html/system/storage/cache/*",
              "sudo rm -rf /var/www/html/system/storage/modification/*",
              "sudo systemctl restart httpd",
              "echo \"=== EC2-A deployment completed ===\""
            ]' \
            --region ap-southeast-1
      
      - name: Deploy to EC2-B via SSM
        run: |
          echo "=== Deploying to EC2-B via SSM Session Manager ==="
          
          aws ssm send-command \
            --instance-ids i-02a745f790cb007a3 \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "echo \"=== Deploying to EC2-B ===\"",
              "sudo cp -r /var/www/html /var/www/html.backup.$(date +%Y%m%d_%H%M%S)",
              "cd /tmp && rm -rf opencart-deployment",
              "git clone https://github.com/WEKONE-26/opencart-aws-group3.git opencart-deployment",
              "sudo rsync -av --exclude=config.php --exclude=admin/config.php --exclude=system/storage/ --exclude=image/ /tmp/opencart-deployment/ /var/www/html/",
              "sudo chown -R apache:apache /var/www/html",
              "sudo chmod -R 755 /var/www/html",
              "sudo rm -rf /var/www/html/system/storage/cache/*",
              "sudo rm -rf /var/www/html/system/storage/modification/*",
              "sudo systemctl restart httpd",
              "echo \"=== EC2-B deployment completed ===\""
            ]' \
            --region ap-southeast-1
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Repository: WEKONE-26/opencart-aws-group3"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed to: EC2-A (i-082cbe43b6ba19a6e), EC2-B (i-02a745f790cb007a3)"
          echo "ALB: Group3-OpenCart-ALB-1956877542.ap-southeast-1.elb.amazonaws.com"
