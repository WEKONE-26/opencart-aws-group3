name: Deploy OpenCart to ASG (All Instances)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Get all ASG instances
        id: get-instances
        run: |
          INSTANCES=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names Group3-OpenCart-ASG \
            --query 'AutoScalingGroups[0].Instances[*].InstanceId' \
            --output text)
          
          echo "instance_ids=$INSTANCES" >> $GITHUB_OUTPUT
          echo "Found instances: $INSTANCES"
      
      - name: Deploy code to all ASG instances
        if: steps.get-instances.outputs.instance_ids != ''
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids ${{ steps.get-instances.outputs.instance_ids }} \
            --parameters 'commands=[
              "set -e",
              "echo \"=== Deploying to ASG Instance ===\"",
              "cd /var/www/html",
              "sudo git fetch origin main",
              "sudo git reset --hard origin/main",
              "sudo systemctl restart httpd",
              "echo \" Deployment completed at \$(date)\\" >> /var/log/deployment.log"
            ]' \
            --region ap-southeast-1 \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          echo "Waiting for deployment to complete..."
          
          # Wait for command to complete (max 5 minutes)
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $(echo ${{ steps.get-instances.outputs.instance_ids }} | awk '{print $1}') \
            --region ap-southeast-1 \
            --query 'Status' \
            --output text || true
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Repository: WEKONE-26/opencart-aws-group3"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "ASG: Group3-OpenCart-ASG"
          echo "Deployed to: All instances in ASG"
          echo "Time: $(date)"
